<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ltsznh.modules.wms.dao.WmsTransferOrderRowDao">

    <!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="com.ltsznh.modules.wms.entity.WmsTransferOrderRowEntity" id="wmsTransferOrderRowMap">
        <result property="toRowId" column="to_row_id"/>
        <result property="toDate" column="to_date"/>
        <result property="toNo" column="to_no"/>
        <result property="toSeq" column="to_seq"/>
        <result property="engineer" column="engineer"/>
        <result property="sourEngineer" column="sour_engineer"/>
        <result property="destEngineer" column="dest_engineer"/>
        <result property="materialCode" column="material_code"/>
        <result property="supplierCode" column="supplier_code"/>
        <result property="guidanceUnitPrice" column="guidance_unit_price"/>
        <result property="unitPrice" column="unit_price"/>
        <result property="qty" column="qty"/>
        <result property="totalAmount" column="total_amount"/>
        <result property="moveTypeCode" column="move_type_code"/>
        <result property="dataStatus" column="data_status"/>
        <result property="confirmId" column="confirm_id"/>
        <result property="confirmTime" column="confirm_time"/>
        <result property="creatorId" column="creator_id"/>
        <result property="createDate" column="create_date"/>
        <result property="modifierId" column="modifier_id"/>
        <result property="modifyDate" column="modify_date"/>
    </resultMap>

    <select id="queryObject" resultType="com.ltsznh.modules.wms.entity.WmsTransferOrderRowEntity">
		select * from wms_transfer_order_row where to_row_id = #{value};
	</select>

    <select id="queryList" resultType="com.ltsznh.modules.wms.entity.WmsTransferOrderRowEntity">
        select ROW_NUMBER() OVER(
        <choose>
            <when test="sidx != null and sidx.trim() != ''">
                order by ${sidx} ${order}
            </when>
            <otherwise>
                order by material_code desc
            </otherwise>
        </choose>
        ) AS ROW_NUM,
        *
        ,(SELECT username FROM sys_user where creator_id = user_id) as creator_name
        ,(SELECT username FROM sys_user where modifier_id = user_id) as modifier_name
        ,CAST(sour_engineer AS VARCHAR )+ ' - ' + (SELECT username FROM sys_user where sour_engineer = user_id) as sour_engineer_name
        ,CAST(dest_engineer AS VARCHAR )+ ' - ' + (SELECT username FROM sys_user where dest_engineer = user_id) as dest_engineer_name
        ,material_code+ ' - ' + (SELECT material_desc FROM pub_material where wms_transfer_order_row.material_code =
        pub_material.material_code) as material_desc
        ,supplier_code+ ' - ' + (SELECT supplier_name FROM pur_supplier where wms_transfer_order_row.supplier_code =
        pur_supplier.supplier_code) as supplier_name
        from wms_transfer_order_row
        <where>
            <if test="toNo != null and toNo.trim() != ''">
                and to_no = #{toNo}
            </if>
        </where>
        ORDER BY ROW_NUM
        <if test="offset != null and limit != null">
            OFFSET #{offset} ROWS
            FETCH NEXT #{limit} ROWS ONLY
        </if>
    </select>

    <select id="queryTotal" resultType="int">
		select count(*) from wms_transfer_order_row 
	</select>

    <insert id="save" parameterType="com.ltsznh.modules.wms.entity.WmsTransferOrderRowEntity">
		insert into wms_transfer_order_row
		(
			[to_date],
			[to_no], 
			[to_seq], 
			[engineer], 
			[sour_engineer], 
			[dest_engineer], 
			[material_code], 
			[supplier_code], 
			[guidance_unit_price], 
			[unit_price], 
			[qty], 
			[total_amount], 
			[move_type_code],
			[remark],
			[confirm_id],
			[confirm_time], 
			[creator_id], 
			[create_date]
		)
		values
		(
			#{toDate},
			#{toNo}, 
			(SELECT ISNULL(MAX([to_seq]),0)+1 AS toSeq FROM wms_transfer_order_row WHERE [to_no] = #{toNo}),
			#{engineer}, 
			#{sourEngineer}, 
			#{destEngineer}, 
			#{materialCode}, 
			#{supplierCode}, 
			#{guidanceUnitPrice}, 
			#{unitPrice}, 
			#{qty}, 
			#{unitPrice}*#{qty},
			#{moveTypeCode},
			#{remark},
			#{confirmId},
			#{confirmTime}, 
			#{creatorId}, 
			#{createDate}
		)
	</insert>

    <!--<update id="update" parameterType="com.ltsznh.modules.wms.entity.WmsTransferOrderRowEntity">-->
    <!--update wms_transfer_order_row -->
    <!--<set>-->
    <!--<if test="toRowId != null">[to_row_id] = #{toRowId}, </if>-->
    <!--<if test="toDate != null">[to_date] = #{toDate}, </if>-->
    <!--<if test="toNo != null">[to_no] = #{toNo}, </if>-->
    <!--<if test="toSeq != null">[to_seq] = #{toSeq}, </if>-->
    <!--<if test="engineer != null">[engineer] = #{engineer}, </if>-->
    <!--<if test="sourEngineer != null">[sour_engineer] = #{sourEngineer}, </if>-->
    <!--<if test="destEngineer != null">[dest_engineer] = #{destEngineer}, </if>-->
    <!--<if test="supplierCode != null">[supplier_code] = #{supplierCode}, </if>-->
    <!--<if test="guidanceUnitPrice != null">[guidance_unit_price] = #{guidanceUnitPrice}, </if>-->
    <!--<if test="unitPrice != null">[unit_price] = #{unitPrice}, </if>-->
    <!--<if test="qty != null">[qty] = #{qty}, </if>-->
    <!--<if test="totalAmount != null">[total_amount] = #{totalAmount}, </if>-->
    <!--<if test="moveTypeCode != null">[move_type_code] = #{moveTypeCode}, </if>-->
    <!--<if test="dataStatus != null">[data_status] = #{dataStatus}, </if>-->
    <!--<if test="confirmId != null">[confirm_id] = #{confirmId}, </if>-->
    <!--<if test="confirmTime != null">[confirm_time] = #{confirmTime}, </if>-->
    <!--<if test="creatorId != null">[creator_id] = #{creatorId}, </if>-->
    <!--<if test="createDate != null">[create_date] = #{createDate}, </if>-->
    <!--<if test="modifierId != null">[modifier_id] = #{modifierId}, </if>-->
    <!--<if test="modifyDate != null">[modify_date] = #{modifyDate}</if>-->
    <!--</set>-->
    <!--where material_code = #{materialCode}-->
    <!--</update>-->

    <delete id="delete">
		DELETE FROM wms_transfer_order_row where to_row_id = #{value};

        DELETE FROM wms_transfer_order_sn
        FROM      wms_transfer_order_sn INNER JOIN
                        wms_transfer_order_row AS b ON wms_transfer_order_sn.to_no = b.to_no AND
                        wms_transfer_order_sn.to_seq = b.to_seq
        WHERE   (b.to_row_id = #{value})
	</delete>

    <delete id="deleteBatch">
        UPDATE wms_transfer_order_row SET data_status = 0,modify_date = GETDATE(),modifier_id = #{modifierId} where
        to_row_id in
        <foreach item="roRowId" collection="array" open="(" separator="," close=")">
            #{roRowId}
        </foreach>;

        DELETE FROM wms_transfer_order_sn
        FROM      wms_transfer_order_sn INNER JOIN
        wms_transfer_order_row AS b ON wms_transfer_order_sn.to_no = b.to_no AND
        wms_transfer_order_sn.to_seq = b.to_seq
        WHERE   b.to_row_id in
        <foreach item="roRowId" collection="array" open="(" separator="," close=")">
            #{roRowId}
        </foreach>;
    </delete>

    <!--<delete id="delete">-->
		<!--UPDATE wms_transfer_order_row SET data_status = 0,modify_date = GETDATE(),modifier_id = #{modifierId} where to_row_id = #{value};-->

	<!--</delete>-->

    <!--<delete id="deleteBatch">-->
        <!--UPDATE wms_transfer_order_row SET data_status = 0,modify_date = GETDATE(),modifier_id = #{modifierId} where-->
        <!--to_row_id in-->
        <!--<foreach item="roRowId" collection="array" open="(" separator="," close=")">-->
            <!--#{roRowId}-->
        <!--</foreach>-->
        <!--;-->

    <!--</delete>-->

</mapper>